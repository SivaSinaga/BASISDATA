<?php
require 'config.php';
cek_login();

$id = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$edit = $id > 0;

$pel = [
  'nama_pelanggan'=>'','alamat'=>'','no_hp'=>'','no_ktp'=>'','created_at'=>date('Y-m-d H:i:s')
];

if ($edit) {
    $res = mysqli_query($conn, "SELECT * FROM pelanggan WHERE id_pelanggan=$id");
    if ($res && mysqli_num_rows($res) === 1) {
        $pel = mysqli_fetch_assoc($res);
    }
}
if (isset($_POST['simpan'])) {
    $nama   = mysqli_real_escape_string($conn, $_POST['nama_pelanggan']);
    $alamat = mysqli_real_escape_string($conn, $_POST['alamat']);
    $hp     = mysqli_real_escape_string($conn, $_POST['no_hp']);
    $ktp    = mysqli_real_escape_string($conn, $_POST['no_ktp']);

    if ($edit) {
        $sql = "UPDATE pelanggan SET nama_pelanggan='$nama', alamat='$alamat',
                no_hp='$hp', no_ktp='$ktp'
                WHERE id_pelanggan=$id";
    } else {
        $sql = "INSERT INTO pelanggan(nama_pelanggan,alamat,no_hp,no_ktp)
                VALUES('$nama','$alamat','$hp','$ktp')";
    }

    mysqli_query($conn, $sql);
    header("Location: pelanggan_list.php");
    exit;
}

include 'templates/header.php';
?>

<h4 class="fw-bold mb-3"><?= $edit ? 'Edit' : 'Tambah' ?> Pelanggan</h4>

<div class="card card-soft">
  <div class="card-body">
    <form method="post" class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Nama</label>
        <input required name="nama_pelanggan" class="form-control" value="<?= htmlspecialchars($pel['nama_pelanggan']) ?>">
      </div>
      <div class="col-md-6">
        <label class="form-label">No HP</label>
        <input name="no_hp" class="form-control" value="<?= htmlspecialchars($pel['no_hp']) ?>">
      </div>
      <div class="col-md-6">
        <label class="form-label">No KTP</label>
        <input required name="no_ktp" class="form-control" value="<?= htmlspecialchars($pel['no_ktp']) ?>">
      </div>
      <div class="col-12">
        <label class="form-label">Alamat</label>
        <textarea name="alamat" class="form-control" rows="3"><?= htmlspecialchars($pel['alamat']) ?></textarea>
      </div>
      <div class="col-12 d-flex gap-2">
        <button type="submit" name="simpan" class="btn btn-pink">Simpan</button>
        <a href="pelanggan_list.php" class="btn btn-outline-secondary">Kembali</a>
      </div>
    </form>
  </div>
</div>

<?php include 'templates/footer.php'; ?>
